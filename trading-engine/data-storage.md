---
description: Отказались от баз данных. Используем Event Sourcing. Пишем в файл.
---

# Хранение данных

**Мы отказались от баз данных**. В базах данных используются транзакции. Транзакции — сложный механизм в базах данных, который не дает деньгам потеряться даже, если в процессе перемещения денег сервер вышел из строя. Так как каждая операция Trading Engine — перемещение денег, каждая операция в базе данных оборачивается в транзакцию и становится сложной и медленной. Это сильно замедляло работу и из-за этого мы отказались от баз данных в Trading Engine.

Вместо балансов пользователей мы храним события пользователя: сделал депозит, выставил ордер. Этот подход называется EventSourcing. Текущий баланс пользователя на диске не хранится. Если во время исполнения события сервер выйдет из строя, деньги не потеряются.

> **Раньше хранили баланс:**
>
> user balance: 100$
>
> **Теперь храним события пользователя:**
>
> * зарегистрировался
> * сделал депозит на $120
> * выставил ордер на покупку BTC за $20

**Trading Engine работает с event sourcing.** На вход получает команды, на выходе — события, результат исполнения входящих команд. События на бирже сохраняются и реплицируются.

![&#x41F;&#x440;&#x438;&#x43C;&#x435;&#x440; &#x432;&#x445;&#x43E;&#x434;&#x44F;&#x449;&#x435;&#x439; &#x43A;&#x43E;&#x43C;&#x430;&#x43D;&#x434;&#x44B; &#x438; &#x438;&#x441;&#x445;&#x43E;&#x434;&#x44F;&#x449;&#x435;&#x433;&#x43E; &#x441;&#x43E;&#x431;&#x44B;&#x442;&#x438;&#x44F;](https://docs.google.com/drawings/d/s1Eze1DeXUih_2VsOEzWBag/image?w=643&h=144&rev=1&ac=1&parent=19LzQnayPQ3eSjqticRPCjV9Yx6cHvz9VXseerapj6_Q)

**Текущее состояние \(балансы, открытые ордера\) имеется только в оперативной памяти**. Если хранить данные ядра биржи в транзакционных базах данных, система не сможет работать достаточно быстро. 

Так как все события записываются, проиграв их можно восстановить текущее состояние биржи.

**События сохраняются в файл**. Для сохранения событий не нужны транзакции и вторичные индексы, не нужно ничего, кроме последовательного чтения и записи в конец файла. Это сильно повышает скорость сохранения данных по сравнению с базой данных и упрощает реплицирование.



