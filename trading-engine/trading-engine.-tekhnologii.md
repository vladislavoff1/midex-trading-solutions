## - - -
description: Что мы использовали и почему

# Trading Engine. Технологии

**Мы отказались от баз данных. **В базах данных используются транзакции. Транзакции — сложный механизм в базах данных, который не дает деньгам потеряться даже, если в процессе перемещения денег сервер вышел из строя. Так как каждая операция Trading Engine — перемещение денег, каждая операция в базе данных оборачивается в транзакцию и становится сложной и медленной. Это сильно замедляло работу и из-за этого мы отказались от баз данных в Trading Engine.

Вместо балансов пользователей мы храним события пользователя: сделал депозит, выставил ордер. Этот подход называется EventSourcing**. **Текущий баланс пользователя на диске не хранится. Если во время исполнения события сервер выйдет из строя, деньги не потеряются.(Почему не потеряются?)  Потому что)
- - -
_Раньше хранили баланс:user balance: 100$_
_Теперь храним события пользователя:_

1. _зарегистрировался_
1. _сделал депозит на $120_
1. _выставил ордер на покупку BTC за $20_
- - -

**Trading Engine работает с event sourcing.** На вход получает команды, на выходе — события, результат исполнения входящих команд. События на бирже сохраняются и реплицируются.
- - -
_Пример входящей команды — создание лимитного ордераПример исходящего события — новый ордер поставлен, или сделка_
- - -

**События сохраняются в файл**. Для сохранения событий не нужны транзакции и вторичные индексы, не нужно ничего, кроме последовательного чтения и записи в конец файла. Это сильно повышает скорость сохранения данных по сравнению с базой данных и упрощает реплицирование.

События кодируются с помощью **Simple Message Encoding**. Так события занимают меньше места и быстрее всего обрабатываются системой.

_Московская финансовая биржа и LMAX стали использовать аналогичное кодирование для своих событий._

**Данные сохраняются одновременно на нескольких серверах.** Если какой-то сервер выйдет из строя, данные не потеряются. Это называется репликацией. Количество серверов с копией данных настраивается. Чем больше копий, тем надежнее система, но тем медленнее она работает.

**Между серверами данные передаются с помощью Aeron. **Aeron — библиотека транспорта сообщений для Java и C ++. Он предназначен для работы с ненадежными медиа-протоколами, такими как UDP и Infiniband, и предлагает упорядоченный обмен сообщениями и дополнительную надежность (путем повторной передачи сообщений в случае пропущенных пакетов). При разработке и реализации особое внимание уделяется коммуникациям с малой задержкой, что делает библиотеку идеальной для использования в приложениях с требованиями реального времени. Реализация Java разработана таким образом, что она не будет генерировать мусор во время выполнения в устойчивом состоянии, уменьшая нагрузку на память и работу для сборщика.