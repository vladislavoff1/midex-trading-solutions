---
description: >-
  CryptoHub - это программное обеспечение, которое является адаптером между
  различными блокчейнами и веб-сервисов Midex, в котором есть модуль пополнения
  и вывода
---

# Введение - СryptoHub

Данное программное обеспечение в рамках биржи получает на вход различные данные из разных API интерфейсов криптовалютных нод и приводит к общему виду для зачисления на счета, либо вывода денежных криптовалютых средств со счетов пользователей биржи. Приложение учитывает особенность каждой криптовалюты и старается привести все к одному виду.

### Валюты

Данное приложение поддерживает на сегодня 11 валют \(BTC, LTC, ETH, DASH, BCH, MDX, NANJ, ADA, NEO, DST, USDT\) и может быть масштабировано до любого количества валют без необходимости доработки

 Сryptoub имеет различные параметры настроек, которые могут как включаться, так и отключаться для каждой валюты: 

* Количество подтверждений - позволяет указывать, до какого числа подтверждений проверять транзакцию к блокчейне. Чаще всего значение равно 6.
* Последний блок - для большинства валют указано, какой последний блок был просканирован. Позволяет видеть реальную ситуацию по просканированным блокам.
* Сверять ли адреса? - опция нужна, когда мы из API интерфейса ноды получаем не только наши транзакции, а вообще все транзакции из блока или из заданного критерия. Для примера: Bitcoin отдает нам только транзакции, которые принадлежат нашим адресам, а клиент для Ethereum отдает нам по API все транзакции
* Адрес выводов - в данном параметре мы можем указывать адрес, куда нужно владельцам отправить криптовалюту, чтобы это криптовалюту пользователи могли вывести на свои внешние адреса

Есть также и другие параметры, которые на данный момент ни на что не влияют, но уже добавлены для удобства реализации нового функционала в будущем.

![](https://lh5.googleusercontent.com/G5OMzDQIejSM-gnK3ve65zqSZUZM6RNXpVdUSvTK8yotvsU9_mi7fptKwigxHRSciv6IirZL4NJLW9ZJBADFH3WxHHiHAof6sfdr9MYWy_XWwdbgcPTBMUXFr64GQ5uAhHp1deXV)

### Криптовалютные ноды

В зависимости от криптовалюты, нам может потребоваться либо одна нода, либо две. Каждая нода имеет набор метрик в мониторинге Zabbix, что позволяет узнавать о проблемах с нодами раньше, чем пользователи напишут об этом в техническую поддержку. Многие ошибки локализуются таким образом, что пользователи не успевают даже эти ошибки заметить.

 Две ноды может понадобиться для таких валют как Bitcoin, Litecoin, Dash, Bitcoin Cash, Cardano, Tether, DeStream. Это нужно потому, что нода является сама по себе кошельком и не смешивает входящие платежи с исходящими. Есть четкое разделение входящего и исходящего кошелька, что позволяет нам при взломе системе не потерять входящие платежи и свести потери к минимуму.

 Однако есть ноды типа Ethereum, Neo, Tron, в которых сам клиент не содержит кошелька с приватными ключами, поэтому для запуска валют на этих нода достаточно одной ноды. Но нужно иметь ввиду, что у криптовалют программное обеспечение достаточно нестабильное, поэтому лучше всегда резервировать ноды и иметь в запасе хотя бы по одной запасной ноде. Запасные ноды не держать в том же месте, а иметь   отдельный сервер, где они будут развернуты.

### **Мониторинг нод**

Каждая нода имеет свое API, свою сюрпризы в плане стабильности и свое метрики для мониторинга работоспособности системы. Практически на всех виртуальных машинах, где расположены как минимум такие метрики как проверка свободного места, оперативной памяти, загрузки процессора, и самая простая метрика - запущен ли процесс ноды. Система мониторинга работает на Zabbix.

 Для нод семейства Bitcoin, куда входит Litecoin, Dash, Bitcoin cash есть метрики, которые проверяют насколько сильно нода отстает, также строятся различные графики загрузки блоков. Мониторинг также считает, было ли изменение блоков за последние полчаса. Ниже представлен пример графика скачивания блоков Bitcoin.

![&#x422;&#x430;&#x43A;&#x43E;&#x439; &#x436;&#x435; &#x433;&#x440;&#x430;&#x444;&#x438;&#x43A; &#x43C;&#x43E;&#x436;&#x43D;&#x43E; &#x443;&#x432;&#x438;&#x434;&#x435;&#x442;&#x44C; &#x438; &#x434;&#x43B;&#x44F; ethereum:](https://lh6.googleusercontent.com/Y1ev7N_7Gk9I_4LU5GBApLg53hmAMvc50aBG0I6c7WjJlK7UMQCy4FJutyA9UrxRPS8DCmyIcpg2zhxZFH3oN7kU6iqKogQ0AV-UCxz-8IO7pF3y6f850XW6iAcYLwFHcuV4LCik)



![](https://lh6.googleusercontent.com/b9NC-S_d_ObpKcRO9POXZhmthYs5rY3JZwOMYD95wn2hS_4_piofeTgU4TTgE9Q9zS7QzNFQCTklE3MG0MrKQlwiF90rNOfnqzDMdCCwT24QsQHVFxkoXI8cmucFxrRQ5ReoTnhM)

У нас на практике была ситуация, что блокчейн одной из развивающихся валют останавливался в майнинге. Благодаря нашим метрикам, которые следят за появлением новых блоков в различные интервалы времени, мы заметили эту проблему и сообщали разработчикам этих валют.

Естественно никто не держит открытым вкладку с панелью Zabbix, это неудобно и можно что-то пропустить. Все важные уведомления отправляются в telegram канал разработчиков и также дублируется на электронную почту.

![](https://lh5.googleusercontent.com/sgaTu_r08EgJvEt99YGgDtc14_NZXjLL0AdppvBKLIvnr8eNOYdNZlmvMU97YOwxDG1VALfpg98n1_RmDZpE7sU1Fr38d1tM0sJSd4fCmfLSpklozGQYXeA9JretmJEEiAeAf8ot)



### **Генерация адресов**

 ****Генерация новых адресов в системе бывает разной: для каких-то адресов приватные ключи сохраняются в базу данных в зашифрованном виде, а к некоторым система вообще не имеет доступа. Далее это можно будет увидеть в сравнении двух нод - bitcoin и ethereum.

 Для валюты bitcoin система использует официальный клиент bitcoin core. У данного клиента есть wallet.dat файл, в котором хранятся все приватные ключи и публичные адреса. У bitcoin core есть функция генерация большого количества запасных адресов с помощью функции keypoolrefill, что позволяет нам нагенерировать в файл большое количество ключей. Далее файл wallet.dat шифруется и передается разработчикам. Получив данный файл, разработчики видят только публичные адреса. Далее Bitcoin core выдает только публичные адреса при выполнении соответствующей команды на получение адреса. Фактически разработчики не имеют доступ к приватным ключам wallet.dat, все пополнения может тратить только владелец этого кошелька.

![](https://lh5.googleusercontent.com/UMEgxXl4g4KMJE-B3WySP0vB9X1ySgrkVb9f2l7nsy6lZ1FI7s_1AV-XKc51rJT6AAHKMrsv76yyFui7EkjrVF0ifc-pnudB-EfDGB1qJ_Wxgk7P-nnLFgoWeVRgIWM1ktI450cK)

Есть  ноды второго тип, такие как ethereum, neo и тд. В этих нодах не используется wallet.dat файл. При работе с такими нодами, система генерирует приватный ключ и публичный адрес, приватный ключ шифрует  AES-256 с ключом, и затем сохраняет в базу данных. Так система работаем с нодами, где нельзя сгенерировать альтернативный wallet.dat файл. Про графу “доступ одобрен” будет рассказано позже**.**

![](https://lh5.googleusercontent.com/HB8BvrMcJTePuaNPeYXK2nP7xU-seL_WIha8DsNmkgkRqm-ZUjv3Dd4JSucBJ2D0L-bhWrTJHjfIo6w9b-rLS9Xy-TZh6K7c3NVJJ5c6dTw3fp648hCXVDWeOQqIy4V-kCXlGfX8)

### **Пополнение аккаунтов**

 **Важным моментом в системе является тот факт, что система не в курсе какому из пользователей принадлежит какой-либо адрес. В зависимости от типа криптовалюты применяется тот или иной способ чтения транзакций из блокчейна.**

 **Для криптовалют, похожих на bitcoin core, система делаем по rpc api протоколу запрос к ноде и получает только транзакции, адрес которых указаны в файле wallet.dat. Никакой пересылкой монет система не занимается, так  как система и разработчики в целом не имею доступ к кошельку.**

 **Для некоторых валют применяется другой способ чтения транзакций из блокчейна. Для примера возьмем клиент для работы с блокчейном ethereum: система запрашивает каждый блок, получает все транзакции, затем смотрит на адрес выхода транзакции. Если данный адрес есть у нас  в базе данных, система сохраняет данные о пополнении. Также, система по определенному правилу и расписанию высылает с данных адресов монеты на холодный кошелек, к которому сами разработчики доступа не имеют.**

 **Независимо от того какая валюта используется, система формирует данные с определенными полями: сумма, адрес, хэш, количество подтверждений. Также в системе  есть специальный алгоритм, который проверяет сколько подтверждений имеет каждая транзакция, и после каждой транзакции уведомляет биржу о изменении этих транзакций.**

### **Вывод средств с аккаунтов**

На бирже также есть функция вывода криптовалютных средств с аккаунтов  пользователей на какие-либо внешние адреса. Биржа присылает системе внутренний ID перевода, сумму и адрес, куда нужно отправить криптовалюту.

Для bitcoin core кошельков мы обязательно поднимаем вторую ноду, где генерируем кошелек и имеем к нему доступ. На данный кошелек владельцы биржи с холодных кошельков отправляют монеты. Благодаря такому варианту работы риск потери криптовалютных средств уменьшается, сумма ущерба находится на минимуме.

Для валют, где мы используем приватные ключи, а не wallet.dat, мы также генерируем приватный ключ и адрес его сообщаем владельцам биржи. С данных адресов в однопоточном режиме идет вывод средств пользователям.

После совершения вывода средств, система сохраняет в базу данных хэш транзакции и затем отправляет данный хэш на биржу. Как правило от отправки транзакции до получения биржей хэша транзакции проходит не более 2-х минут.

Балансы кошельков также подключены к отдельному мониторингу, и когда на кошельках остается минимальная сумма, или сумма выводов больше, чем есть на балансе кошельков выводов - система отправляет в специальный telegram чат владельцам биржи информацию о нехватке средств.  


### **ERC-20 токены**

Отдельно стоит отметить erc-20 токены, работающие у нас на платформе ethereum. Проблем при пополнении кошельков токенам не возникает, однако эти токены нужно еще как-то отправить владельцам биржи. Но есть проблема: чтобы применить метод transfer в сторону смарт-контракта, нужно оплатить топливо для совершения транзакции.

Первая идея, которая пришла нам в голову была следующей:

1. Если на адресе есть токены, идем дальше
2. Если нет эфира на адресе, пополняем адрес эфиром
3. Делаем запрос transfer в адрес смарт-контракта чтобы переместить токены на новый адрес

Однако данный способ очень не экономичный: при каждом пополнении кошелька токенами приходилось бы пополнить его эфиром и затем снова сделать запрос в адрес смарт-контракта. Чтобы сэкономить средства на комиссиях, был придуман достаточно хитрый и непрозрачный способ вывода средств.

 В логика системы были добавлены новые кошельки:

* Сервисный кошелек deposit: кошелек, с которого отправляется определенное количество эфира на адреса, на которых есть токены
* Сервисный кошелек transfer: кошелек, который вызывает метод transferFrom для вывода токена с одного кошелька на другой \(для этого нужно получить доверенность к адресу с помощью метода approve\)

Алгоритм работы по сбору средств следующий:

1. Если на кошелек пришли токены, проверяем, был ли сделан approve в адрес смарт-контракта ранее
2. Если не было approve для сервисного кошелька transfer, то кошелек deposit отправляет на данный адрес eth \(если на данном адресе нет eth\)
3. Если кошелек был пополнен eth и не был вызван метод approve, то на адрес смарт-контракта отправляется транзакция с методом approve и выдается доверенность на выполнение транзакций с сервисного кошелька transfer.
4. Сервисный кошелек transfer вызывает метод transferFrom и выводит с кошельков пополнений токены

В итоге мы имеем следующую картину: после первого пополнения кошелька токенами, сервисный кошелек deposit пополняет его eth, отправляет запрос approve в смарт-контракт, и затем сервисный кошелек transfer выводит все токены на новый кошелек. Далее при пополнении этого же адреса, сервисный кошелек transfer сам выведет токены.  


